# Software Support for Pynq Power Ranger

## üöÄ Description

This folder contains two use examples that use the Pynq Power Ranger to measure the energy consumption of the Pynq Z2 board (TUL). Each example includes:
- The **[XADC IP configuration](Basic_Monitoring_SW_Power/HW/recreate_xadc.tcl)** to read the current measurement from the pin VP of the Power Ranger board. This IP is connected to the AXI4 bus to be controlled from the processing system.
- A **[C Proxy driver](Basic_Monitoring_SW_Power/SW/src/CXADCProxy.cpp)** to interface with the XADC IP from a Linux application. 

> [NOTE] These examples assume that the Power Ranger is set to measure from the VP pin and the power is supplied from the USB connector with a typical input supply of 5V. The sampling rate of the XADC is set to 123 MHz.

## üìÅ Contents
This folder contains two examples:
- **[Basic Monitoring](Basic_Monitoring_SW_Power)**: A more advanced example that continuously monitors the current consumption and logs the data to a file.
- **[Moving Average](ExampleMovingAvg)**: An example that applies a moving average filter to the current measurements to smooth out fluctuations.

To simplify integration in other projects, the **XADC IP Configuration and implementation** is provided in each example through the file "[recreate_xadc.tcl](Basic_Monitoring_SW_Power/HW/recreate_xadc.tcl)". This file is used to include and configure the XADC module in a block diagram in Vivado.

On each example there are two folders:
- **HW**: The Vivado project to generate the bitstream with the XADC IP. It include a Makefile with multiple targets for the project and bitstream generation. Use 'make help' to display the list of available targets.
- **SW**: The SW necessary to create a C/C++ application in Linux, inside the Pynq board. The application implements a driver to communicate with the XADC IP and read the current consumption. These SW examples are meant to be compiled inside the Pynq board!

> [NOTE] All the examples are for execution with Vitis HLS and Vivado 2022.2.

## üèÉ‚Äç‚ôÇÔ∏è How to Run

Follow these steps to run the examples on your Pynq board:

### 1. Bitstream Generation
Go to the HW folder in a PC with Vivado installed, and generate the bitstream using the provided Makefile:
```bash
make bitstream
```

A .bit and .hwh files will be generated in the folder HW folder. These files are needed to program the FPGA in the Pynq board.

### 2. Bitstream Configuration
There are several alternatives to program the FPGA with the generated bitstream:
- Using the Vivado GUI, by opening the generated project and programming the FPGA directly. Open the HW Manager, connect to the board and program the FPGA with the generated .bit file.
- Directly from the Pynq board itself using the provided '[programOverlay.py](Basic_Monitoring_SW_Power/SW/programOverlay.py)' script. The script requires the '.bit' and '.hwh' files generated by Vivado. Copy the generated '.bit' and '.hwh' files to the Pynq board and run `sudo -E ./programOverlay.py <path_to_.bit>`.  
- Using the Pynq framework (Jupyter Notebooks). Copy the generated '.bit' and '.hwh' files to the Pynq board and refer to [Loading and Overlay](https://pynq.readthedocs.io/en/latest/pynq_overlays/loading_an_overlay.html) for more information on how to load an overlay.
- Using the fpga_manager module in Linux (fpgautil). For this, you need to generate the corresponding '.bin' files from the .bit using bootgen. Then run `sudo fpgautil -b <path_to_.bin>`.
- using the fpga_manager module manually. Copy the generated '.bit' file to the Pynq board and run the following as sudo:
```bash
echo 0 > /sys/class/fpga_manager/fpga0/flags
mkdir -p /lib/firmware
cp bitstream/accel_v$acc/design_1.bit.bin /lib/firmware/
echo <path_to_.bin> > /sys/class/fpga_manager/fpga0/firmware # Load bitstream
```

### 3. Run the Application
Copy the SW folder in the Pynq board running Linux. Then compile and run the application using the provided Makefile:
```bash
make
./PowerRanger # or ./testMovingAvg for the moving average example
```

## üñ•Ô∏è Basic Monitoring

Live monitoring of the current consumption is implemented in this example. The application reads the current consumption from the XADC IP every second and prints the value of power and energy to the console. If run in parallel with a benchmark application, it can be used to measure the energy consumption of the benchmark.

> [WARNING!] It will only work if the XADC IP is configured as in the example folder, if the bitstream is overwritten the program wont be able to communicate with the XADC.

## üßÆ Moving Average Filter

This example demonstrates an HLS implementation of a moving average filter with a window size of 7 samples. The application evaluates performance by measuring execution time and energy consumption when processing 8 million samples using three approaches: (i) a standard software version, (ii) an optimized software version, and (iii) a hardware version generated with HLS. The results are printed to the console. In summary, this example illustrates how to integrate power measurements into an application using the XADC proxy driver.
